(function(i){if(typeof Array.isArray!=="function")Array.isArray=function(b){return Object.prototype.toString.call(b)==="[object Array]"};if(!Array.prototype.indexOf)Array.prototype.indexOf=function(b){for(var e=0,a=this.length;e<a;e++)if(this[e]===b)return e;return-1};var i=i.EventEmitter=function(){},h=Array.isArray;i.prototype.emit=function(b){if(b==="error"&&(!this._events||!this._events.error||h(this._events.error)&&!this._events.error.length))if(arguments[1]instanceof Error)throw arguments[1];
else throw Error("Uncaught, unspecified 'error' event.");if(!this._events)return false;var e=this._events[b];if(!e)return false;if(typeof e=="function"){switch(arguments.length){case 1:e.call(this);break;case 2:e.call(this,arguments[1]);break;case 3:e.call(this,arguments[1],arguments[2]);break;default:var a=Array.prototype.slice.call(arguments,1);e.apply(this,a)}return true}else if(h(e)){for(var a=Array.prototype.slice.call(arguments,1),e=e.slice(),g=0,d=e.length;g<d;g++)e[g].apply(this,a);return true}else return false};
i.prototype.addListener=function(b,e){if("function"!==typeof e)throw Error("addListener only takes instances of Function");if(!this._events)this._events={};this.emit("newListener",b,e);this._events[b]?h(this._events[b])?this._events[b].push(e):this._events[b]=[this._events[b],e]:this._events[b]=e;return this};i.prototype.on=i.prototype.addListener;i.prototype.once=function(b,e){var a=this;a.on(b,function d(){a.removeListener(b,d);e.apply(this,arguments)})};i.prototype.removeListener=function(b,e){if("function"!==
typeof e)throw Error("removeListener only takes instances of Function");if(!this._events||!this._events[b])return this;var a=this._events[b];if(h(a)){var g=a.indexOf(e);if(g<0)return this;a.splice(g,1);a.length==0&&delete this._events[b]}else this._events[b]===e&&delete this._events[b];return this};i.prototype.removeAllListeners=function(b){b&&this._events&&this._events[b]&&(this._events[b]=null);return this};i.prototype.listeners=function(b){if(!this._events)this._events={};this._events[b]||(this._events[b]=
[]);h(this._events[b])||(this._events[b]=[this._events[b]]);return this._events[b]}})(typeof exports==="undefined"?window:exports);(function(i){var h="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math==="undefined"&&(Math={});Math.uuid=function(b,e){var a=[],e=e||h.length;if(b)for(var g=0;g<b;g++)a[g]=h[0|Math.random()*e];else{var d;a[8]=a[13]=a[18]=a[23]="-";a[14]="4";for(g=0;g<36;g++)a[g]||(d=0|Math.random()*16,a[g]=h[g==19?d&3|8:d])}return a.join("")};Math.uuidFast=function(){for(var b=Array(36),e=0,a,g=0;g<36;g++)g==8||g==13||g==18||g==23?b[g]="-":g==14?b[g]="4":(e<=2&&(e=33554432+Math.random()*
16777216|0),a=e&15,e>>=4,b[g]=h[g==19?a&3|8:a]);return b.join("")};Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var e=Math.random()*16|0;return(b=="x"?e:e&3|8).toString(16)}).toUpperCase()};i.Math=Math})(typeof exports==="undefined"?window:exports);(function(i){var h=Object.keys||function(a){var d=[],k;for(k in a)a.hasOwnProperty(k)&&d.push(k);return d},b=function(a,d){var k=Array.prototype[a];return function(f,c,e){var b=f?f[a]:0;return b&&b===k?b.call(f,c,e):d(f,c,e)}},e=b("forEach",function(a,d){for(var f=a instanceof Object,c=f?h(a):a||[],e=0,b=c.length;e<b;e++){var j=f?c[e]:e;d(a[j],j,a)}}),a=function(a,d,f){var c=a.length||h(a).length;if(!c)return f();var b=0;e(a,function(){var a=Array.prototype.slice.call(arguments,0,d.length-1);a[d.length-
1]=function(a){a?(f(a),f=function(){}):++b===c&&f()};d.apply(this,a)})},g=function(a,d,f){var c=h(a);if(!c.length)return f();var e=0,b=function(){var j=c[e],j=[a[j],j,a].slice(0,d.length-1);j[d.length-1]=function(a){a?(f(a),f=function(){}):++e===c.length?f():b()};d.apply(this,j)};b()},d=b("map",function(a,d){var f=[];e(a,function(a,c,e){f[f.length]=d(a,c,e)});return f}),c=function(a){return function(f,d,c){var e=[];a(f,function(a,f,c,b){a=[a,f,c].slice(0,d.length-1);a[d.length-1]=function(a,f){e[e.length]=
f;b(a)};d.apply(this,a)},function(a){c(a,e)})}},f=b("filter",function(a,f){var d=[];e(a,function(a,c,e){f(a,c,e)&&(d[d.length]=a)});return d}),j=function(f,d,c){var e=[];a(f,function(a,f,c,b){f=[a,f,c].slice(0,d.length-1);f[d.length-1]=function(f,d){d&&(e[e.length]=a);b(f)};d.apply(this,f)},function(a){c(a,e)})},n=b("reduce",function(a,f,d){e(a,function(a,c,e){d=f(d,a,c,e)});return d}),l=function(a,f,d,c){g(a,function(a,c,e,b){a=[d,a,c,e].slice(0,f.length-1);a[f.length-1]=function(a,f){d=f;b(a)};
f.apply(this,a)},function(a){c(a,d)})};i.each=function(f,d,c){return(c?a:e)(f,d,c)};i.map=function(f,e,b){return(b?c(a):d)(f,e,b)};i.filter=function(a,d,c){return(c?j:f)(a,d,c)};i.reduce=function(a,f,d,c){return(c?l:n)(a,f,d,c)};i.parallel=function(f,d){var c=new f.constructor;a(f,function(a,f,d){a(function(a){var e=Array.prototype.slice.call(arguments,1);c[f]=e.length<=1?e[0]:e;d(a)})},function(a){(d||function(){})(a,c)})};i.series=function(a,f){var d=new a.constructor;g(a,function(a,f,c){a(function(a,
e){var b=Array.prototype.slice.call(arguments,1);d[f]=b.length<=1?b[0]:b;c(a)})},function(a){(f||function(){})(a,d)})}})(typeof exports==="undefined"?this._={}:exports);(function(i){var h=typeof window==="undefined"?require("websocket-client").WebSocket:window.WebSocket,b={frame:function(e,a,b){return{command:e,headers:a,body:b,toString:function(){var d=e+"\n";if(a)for(header in a)a.hasOwnProperty(header)&&(d=d+header+": "+a[header]+"\n");b&&(d=d+"content-length: "+b.length+"\n");d+="\n";b&&(d+=b);return d}}}};trim=function(e){return e.replace(/^\s+/g,"").replace(/\s+$/g,"")};b.unmarshal=function(e){for(var a=e.search(/\n\n/),g=e.substring(0,a).split("\n"),d=g.shift(),
c={},f="",j=idx=null,h=0;h<g.length;h++)j=g[h],idx=j.indexOf(":"),c[trim(j.substring(0,idx))]=trim(j.substring(idx+1));g=null;for(h=a+2;h<e.length;h++){g=e.charAt(h);if(g==="\x00")break;f+=g}return b.frame(d,c,f)};b.marshal=function(e,a,g){return b.frame(e,a,g).toString()+"\x00"};b.client=function(e){var a,g,d=0,c={};debug=function(f){a.debug&&a.debug(f)};onmessage=function(f){debug("<<< "+f.data);f=b.unmarshal(f.data);if(f.command==="CONNECTED"&&a.connectCallback)a.connectCallback(f);else if(f.command===
"MESSAGE"){var d=c[f.headers.subscription];d&&d(f)}else if(f.command==="RECEIPT"&&a.onreceipt)a.onreceipt(f);else if(f.command==="ERROR"&&a.onerror)a.onerror(f)};transmit=function(a,d,c){a=b.marshal(a,d,c);debug(">>> "+a);g.send(a)};a={};a.connect=function(d,c,b,i){debug("Opening Web Socket...");g=new h(e);g.onmessage=onmessage;g.onerror=i;g.onclose=function(){var a="Whoops! Lost connection to "+e;debug(a);i&&i(a)};g.onopen=function(){debug("Web Socket Opened...");transmit("CONNECT")};a.connectCallback=
b};a.disconnect=function(a){transmit("DISCONNECT");g.close();a&&a()};a.send=function(a,d,c){d=d||{};d.destination=a;transmit("SEND",d,c)};a.subscribe=function(a,e,b){var b=b||{},g="sub-"+d++;b.destination=a;b.id=g;c[g]=e;transmit("SUBSCRIBE",b);return g};a.unsubscribe=function(a,d){d=d||{};d.id=a;delete c[a];transmit("UNSUBSCRIBE",d)};a.begin=function(a,d){d=d||{};d.transaction=a;transmit("BEGIN",d)};a.commit=function(a,d){d=d||{};d.transaction=a;transmit("COMMIT",d)};a.abort=function(a,d){d=d||{};
d.transaction=a;transmit("ABORT",d)};a.ack=function(a,d){d=d||{};d["message-id"]=a;transmit("ACK",d)};return a};i.Stomp=b})(typeof exports==="undefined"?window:exports);(function(i){function h(a,c){var f=/^(.*)\//;return a.authority&&!a.path?"/"+c:a.getPath().match(f)[0]+c}function b(a){if(!a)return"";a=a.replace(/\/\.\//g,"/");for(a=a.replace(/\/\.$/,"/");a.match(g);)a=a.replace(g,"/");for(a=a.replace(/\/([^\/]*)\/\.\.$/,"/");a.match(/\/\.\.\//);)a=a.replace(/\/\.\.\//,"/");return a}var e,a,g=/\/((?!\.\.\/)[^\/]*)\/\.\.\//;e=function(a){a||(a="");var a=a.match(/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/),c=a[1]||null,f=a[2]||null,
b=a[3]||null,e=a[4]||null,g=a[5]||null;this.getScheme=function(){return c};this.setScheme=function(a){c=a};this.getAuthority=function(){return f};this.setAuthority=function(a){f=a};this.getPath=function(){return b};this.setPath=function(a){b=a};this.getQuery=function(){return e};this.setQuery=function(a){e=a};this.getFragment=function(){return g};this.setFragment=function(a){g=a}};e.prototype.toString=function(){var a="";this.getScheme()&&(a+=this.getScheme()+":");this.getAuthority()&&(a+="//"+this.getAuthority());
this.getPath()&&(a+=this.getPath());this.getQuery()&&(a+="?"+this.getQuery());this.getFragment()&&(a+="#"+this.getFragment());return a};e.prototype.resolve=function(a){var c=new e;this.getScheme()?(c.setScheme(this.getScheme()),c.setAuthority(this.getAuthority()),c.setPath(b(this.getPath())),c.setQuery(this.getQuery())):(this.getAuthority()?(c.setAuthority(this.getAuthority()),c.setPath(b(this.getPath())),c.setQuery(this.getQuery())):(this.getPath()?(this.getPath().charAt(0)==="/"?c.setPath(b(this.getPath())):
(c.setPath(h(a,this.getPath())),c.setPath(b(c.getPath()))),c.setQuery(this.getQuery())):(c.setPath(a.getPath()),this.getQuery()?c.setQuery(this.getQuery()):c.setQuery(a.getQuery())),c.setAuthority(a.getAuthority())),c.setScheme(a.getScheme()));c.setFragment(this.getFragment());return c};e.prototype.parseQuery=function(){return a.fromString(this.getQuery(),this.querySeparator)};a=function(){this.params={};this.separator="&"};a.fromString=function(d,c){var f=new a;if(c)f.separator=c;f.addStringParams(d);
return f};a.prototype.addStringParams=function(a){for(var a=a.split(this.separator),c,f,b=0;b<a.length;b++)c=a[b].split("=",2),f=c[0].replace(/\+/g," "),c=c[1].replace(/\+/g," "),this.params.hasOwnProperty(f)||(this.params[f]=[]),this.params[f].push(c)};a.prototype.getParam=function(a){return this.params.hasOwnProperty(a)?this.params[a][0]:null};a.prototype.toString=function(){var a=[],c;c=this.params;var f=[],b;for(b in c)c.hasOwnProperty(b)&&f.push(b);c=f.sort();for(f=0;f<c.length;f++)for(b=0;b<
this.params[c[f]].length;b++)a.push(c[f].replace(/ /g,"+")+"="+this.params[c[f]][b].replace(/ /g,"+"));return a.join(this.separator)};i.URI=e;i.URIQuery=a})(typeof exports==="undefined"?window:exports);(function(i){i.Serializer=function(){this.serialize=function(h){return JSON.stringify(h)};this.deserialize=function(h){return JSON.parse(h)}}})(typeof exports==="undefined"?this["masstransit.Serializer"]={}:exports);(function(i){var h=typeof window==="undefined"?require("nimble"):window._,b=typeof window==="undefined"?require("./log"):window["masstransit.Log"];i.SubscriptionClient=function(e,a,g){var d=[];e.on("urn:message:MassTransit.Services.Subscriptions.Messages:SubscriptionRefresh",function(a){b.info("subscription refresh handling");h.each(a.subscriptions,function(a){b.info("subscription add: "+a.messageName+" from "+a.endpointUri);h.filter(d,function(c){return c.subscriptionId==a.subscriptionId}).length==
0&&d.push(a)});this.emit("subscriptionClientReady")});e.on("urn:message:MassTransit.Services.Subscriptions.Messages:RemoveSubscription",function(a){b.info("subscription remove handling: "+a.subscription.messageName+" from "+a.subscription.endpointUri);d=h.filter(d,function(b){return b.subscriptionId!=a.subscription.subscriptionId})});e.on("urn:message:MassTransit.Services.Subscriptions.Messages:AddSubscription",function(a){b.info("subscription add handling: "+a.subscription.messageName+" from "+a.subscription.endpointUri);
h.filter(d,function(b){return b.subscriptionId==a.subscription.subscriptionId}).length==0&&d.push(a.subscription)});this.addSubscription=function(c){b.info("adding a message consumer for: "+c);c={subscription:{clientId:a.clientId,sequenceNumber:1,messageName:c,endpointUri:a.receiveFrom.toString(),subscriptionId:Math.uuid()}};g.send({messageType:"urn:message:MassTransit.Services.Subscriptions.Messages:AddSubscription",message:c})};this.addSubscriptionClient=function(){b.info("registering a new client in the pool");
a.clientId=Math.uuid().toLowerCase();g.send({messageType:"urn:message:MassTransit.Services.Subscriptions.Messages:AddSubscriptionClient",message:{correlationId:a.clientId,controlUri:a.receiveFrom.toString(),dataUri:a.receiveFrom.toString()}})};this.getSubscriptions=function(){return d}}})(typeof exports==="undefined"?this["masstransit.SubscriptionClient"]={}:exports);(function(i){function h(a,b){h.prototype.__proto__=e.prototype;var d=new c;this.on("internalMessage",function(b){b=d.deserialize(b);b.destinationAddress==a.toString()&&this.emit("message",b)});this.send=function(c){b.send(a.getPath(),{},d.serialize(c))}}var b=typeof window==="undefined"?require("nimble"):window._,e=typeof window==="undefined"?require("events").EventEmitter:window.EventEmitter,a=typeof window==="undefined"?require("../inc/Math.uuid").Math:window.Math,g=typeof window==="undefined"?
require("../inc/uri").URI:window.URI,d=typeof window==="undefined"?require("../inc/stompclient").Stomp:window.Stomp,c=typeof window==="undefined"?require("../serializer").Serializer:window["masstransit.Serializer"].Serializer,f=typeof window==="undefined"?require("../log"):window["masstransit.Log"];i.TransportFactory=function(){function c(a,g,k){var j=e(a);g||(g=function(){});k||(k=function(){});var q;b.filter(i,function(b){if(b.address.getAuthority()==a.getAuthority()){f.info("connection to ws://"+
a.getAuthority()+" found in cache");q=true;var c=new h(a,b.client);g(c,b.client)}});if(!q){f.info("connection to "+j+" not found in cache, bulding");var m=new d.client(j);m.debug=f.debug;var r=new h(a,m);m.connect(null,null,function(){f.info("outbound connection ready: "+a);i.push({address:a,client:m});g(r,m)},function(){f.info("error building connection to: "+j);k()})}}function e(a){a=new g(a.toString());a.setScheme("ws");return a="ws://"+a.getAuthority()}var i=[];this.buildOutbound=c;this.buildInbound=
function(b,d){d||(d=function(){});var e;c(b,function(c,g){var h=b.getPath(),i=a.uuid();f.info("subscribing to: "+h);g.onreceipt=function(a){a.headers["receipt-id"]=="subscription-"+i&&(e=setInterval(function(){f.debug("sending connection poll message");g.send(h,{},"connected to:"+h)},1500))};g.subscribe(h,function(a){switch(a.command){case "MESSAGE":a.body=="connected to:"+h?e&&(clearInterval(e),d(c),e=null):c.emit("internalMessage",a.body)}},{receipt:"subscription-"+i})})}}})(typeof exports==="undefined"?
this["masstransit.stompTransportFactory"]={}:exports);(function(i){function h(c){function f(b){a.info("trigger event: "+b.messageType[0]);this.emit(b.messageType[0],b.message)}function i(a){var a=a.split(",")[0],b=a.lastIndexOf("."),a=a.substring(0,b)+":"+a.substring(b+1);return"urn:message:"+a}h.prototype.__proto__=e.prototype;var n=false,l=this,o;c.receiveFrom=new g(c.receiveFrom);c.subscriptionService=new g(c.subscriptionService);var p=new (typeof masstransit==="undefined"?c.transport.indexOf("/")===0?require(c.transport).TransportFactory:require("./transport/"+
c.transport).TransportFactory:window["masstransit."+c.transport+"TransportFactory"].TransportFactory)(c.dialect);this.init=function(){a.info("initializing the servicebus");p.buildOutbound(c.subscriptionService,function(b){a.info("outbound connection for subscription client ready");p.buildInbound(c.receiveFrom,function(e){a.info("message transport ready, subscribing new client");e.on("message",function(a){f.apply(l,[a])});o=new d(l,c,b);l.once("subscriptionClientReady",function(){l.emit("ready");n=
true});o.addSubscriptionClient()},function(){l.emit("disconnect","messageTransport")})},function(){l.emit("disconnect","subscription client")})};this.subscribe=function(b,c){a.info("subscribing to : "+b);o.addSubscription(b);if(c!=null)this.on(i(b),c)};this.publish=function(c,d){n?(a.info("searching for a subscription for: "+c),b.each(o.getSubscriptions(),function(b){i(b.messageName)==c&&(a.info("found"),p.buildOutbound(new g(b.endpointUri),function(a){a.send({messageType:c,message:d})}))})):a.info("bus is not initialed yet, can't publish your message")};
this.isReady=function(){return n}}var b=typeof window==="undefined"?require("nimble"):window._,e=typeof window==="undefined"?require("events").EventEmitter:window.EventEmitter,a=typeof window==="undefined"?require("./log"):window["masstransit.Log"],g=typeof window==="undefined"?require("./inc/uri").URI:window.URI,d=typeof window==="undefined"?require("./subscriptionclient").SubscriptionClient:window["masstransit.SubscriptionClient"].SubscriptionClient;i.Servicebus=h})(typeof exports==="undefined"?
this.masstransit={}:exports);
